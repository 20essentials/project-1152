var scene,camera,fieldOfView,aspectRatio,nearPlane,farPlane,gobalLight,shadowLight,backLight,renderer,container,controls,HEIGHT,WIDTH,windowHalfX,windowHalfY,hero,mousePos={x:0,y:0},oldMousePos={x:0,y:0},ballWallDepth=28;function initScreenAnd3D(){HEIGHT=window.innerHeight,WIDTH=window.innerWidth,windowHalfX=WIDTH/2,windowHalfY=HEIGHT/2,scene=new THREE.Scene,aspectRatio=WIDTH/HEIGHT,fieldOfView=50,nearPlane=1,farPlane=2e3,(camera=new THREE.PerspectiveCamera(fieldOfView,aspectRatio,nearPlane,farPlane)).position.x=0,camera.position.z=300,camera.position.y=250,camera.lookAt(new THREE.Vector3(0,60,0)),(renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0})).setPixelRatio(window.devicePixelRatio),renderer.setSize(WIDTH,HEIGHT),renderer.shadowMapEnabled=!0,(container=document.getElementById("world")).appendChild(renderer.domElement),window.addEventListener("resize",handleWindowResize,!1),document.addEventListener("mousemove",handleMouseMove,!1),document.addEventListener("touchmove",handleTouchMove,!1)}function handleWindowResize(){HEIGHT=window.innerHeight,WIDTH=window.innerWidth,windowHalfX=WIDTH/2,windowHalfY=HEIGHT/2,renderer.setSize(WIDTH,HEIGHT),camera.aspect=WIDTH/HEIGHT,camera.updateProjectionMatrix()}function handleMouseMove(e){mousePos={x:e.clientX,y:e.clientY}}function handleTouchMove(e){1==e.touches.length&&(e.preventDefault(),mousePos={x:e.touches[0].pageX,y:e.touches[0].pageY})}function createLights(){globalLight=new THREE.HemisphereLight(16777215,16777215,.5),(shadowLight=new THREE.DirectionalLight(16777215,.9)).position.set(200,200,200),shadowLight.castShadow=!0,shadowLight.shadowDarkness=.2,shadowLight.shadowMapWidth=shadowLight.shadowMapHeight=2048,(backLight=new THREE.DirectionalLight(16777215,.4)).position.set(-100,100,100),backLight.castShadow=!0,backLight.shadowDarkness=.1,backLight.shadowMapWidth=shadowLight.shadowMapHeight=2048,scene.add(globalLight),scene.add(shadowLight),scene.add(backLight)}function createFloor(){floor=new THREE.Mesh(new THREE.PlaneBufferGeometry(1e3,1e3),new THREE.MeshBasicMaterial({color:7261388})),floor.rotation.x=-Math.PI/2,floor.position.y=0,floor.receiveShadow=!0,scene.add(floor)}function createHero(){hero=new Cat,scene.add(hero.threeGroup)}function createBall(){ball=new Ball,scene.add(ball.threeGroup)}var woolNodes=10,woolSegLength=2,gravity=-.8,accuracy=1;Ball=function(){var e=new THREE.MeshLambertMaterial({color:6491413,shading:THREE.FlatShading}),t=new THREE.LineBasicMaterial({color:6491413,linewidth:3});this.threeGroup=new THREE.Group,this.ballRay=8,this.verts=[];for(var i=new THREE.Geometry,o=0;o<woolNodes;o++){var s=new THREE.Vector3(0,-o*woolSegLength,0);i.vertices.push(s);var r=new WoolVert;r.x=r.oldx=s.x,r.y=r.oldy=s.y,r.z=0,r.fx=r.fy=0,r.isRootNode=0==o,r.vertex=s,o>0&&r.attach(this.verts[o-1]),this.verts.push(r)}this.string=new THREE.Line(i,t);var a=new THREE.SphereGeometry(this.ballRay,5,4);this.body=new THREE.Mesh(a,e),this.body.position.y=-woolSegLength*woolNodes;var n=new THREE.TorusGeometry(this.ballRay,.5,3,10,2*Math.PI);this.wire1=new THREE.Mesh(n,e),this.wire1.position.x=1,this.wire1.rotation.x=-Math.PI/4,this.wire2=this.wire1.clone(),this.wire2.position.y=1,this.wire2.position.x=-1,this.wire1.rotation.x=-Math.PI/4+.5,this.wire1.rotation.y=-Math.PI/6,this.wire3=this.wire1.clone(),this.wire3.rotation.x=-Math.PI/2+.3,this.wire4=this.wire1.clone(),this.wire4.position.x=-1,this.wire4.rotation.x=-Math.PI/2+.7,this.wire5=this.wire1.clone(),this.wire5.position.x=2,this.wire5.rotation.x=-Math.PI/2+1,this.wire6=this.wire1.clone(),this.wire6.position.x=2,this.wire6.position.z=1,this.wire6.rotation.x=1,this.wire7=this.wire1.clone(),this.wire7.position.x=1.5,this.wire7.rotation.x=1.1,this.wire8=this.wire1.clone(),this.wire8.position.x=1,this.wire8.rotation.x=1.3,this.wire9=this.wire1.clone(),this.wire9.scale.set(1.2,1.1,1.1),this.wire9.rotation.z=Math.PI/2,this.wire9.rotation.y=Math.PI/2,this.wire9.position.y=1,this.body.add(this.wire1),this.body.add(this.wire2),this.body.add(this.wire3),this.body.add(this.wire4),this.body.add(this.wire5),this.body.add(this.wire6),this.body.add(this.wire7),this.body.add(this.wire8),this.body.add(this.wire9),this.threeGroup.add(this.string),this.threeGroup.add(this.body),this.threeGroup.traverse((function(e){e instanceof THREE.Mesh&&(e.castShadow=!0,e.receiveShadow=!0)}))},WoolVert=function(){this.x=0,this.y=0,this.z=0,this.oldx=0,this.oldy=0,this.fx=0,this.fy=0,this.isRootNode=!1,this.constraints=[],this.vertex=null},WoolVert.prototype.update=function(){this.add_force(0,gravity),nx=this.x+.9*(this.x-this.oldx)+this.fx,ny=this.y+.9*(this.y-this.oldy)+this.fy,this.oldx=this.x,this.oldy=this.y,this.x=nx,this.y=ny,this.vertex.x=this.x,this.vertex.y=this.y,this.vertex.z=this.z,this.fy=this.fx=0},WoolVert.prototype.attach=function(e){this.constraints.push(new Constraint(this,e))},WoolVert.prototype.add_force=function(e,t){this.fx+=e,this.fy+=t},Constraint=function(e,t){this.p1=e,this.p2=t,this.length=woolSegLength},Ball.prototype.update=function(e,t,i){for(var o=accuracy;o--;)for(var s=woolNodes;s--;){var r=this.verts[s];if(r.isRootNode)r.x=e,r.y=t,r.z=i;else{for(var a=r.constraints.length;a--;){var n=r.constraints[a],h=n.p1.x-n.p2.x,d=n.p1.y-n.p2.y,l=Math.sqrt(h*h+d*d),w=(n.length-l)/l,c=h*w*.5,p=d*w*.5;n.p1.x+=c,n.p1.y+=p,n.p2.x-=c,n.p2.y-=p,n.p1.z=n.p2.z=i}s==woolNodes-1&&(this.body.position.x=this.verts[s].x,this.body.position.y=this.verts[s].y,this.body.position.z=this.verts[s].z,this.body.rotation.z+=r.y<=this.ballRay?(r.oldx-r.x)/10:Math.min(Math.max(h/2,-.1),.1))}r.y<this.ballRay&&(r.y=this.ballRay)}for(s=woolNodes;s--;)this.verts[s].update();this.string.geometry.verticesNeedUpdate=!0},Ball.prototype.receivePower=function(e){this.verts[woolNodes-1].add_force(e.x,e.y)};var t=0;function loop(){render(),t+=.05,hero.updateTail(t);var e=getBallPos();ball.update(e.x,e.y,e.z),ball.receivePower(hero.transferPower),hero.interactWithBall(ball.body.position),requestAnimationFrame(loop)}function getBallPos(){var e=new THREE.Vector3;e.set(mousePos.x/window.innerWidth*2-1,-mousePos.y/window.innerHeight*2+1,.1),e.unproject(camera);var t=e.sub(camera.position).normalize(),i=(ballWallDepth-camera.position.z)/t.z;return camera.position.clone().add(t.multiplyScalar(i))}function render(){controls&&controls.update(),renderer.render(scene,camera)}function init(e){initScreenAnd3D(),createLights(),createFloor(),createHero(),createBall(),loop()}window.addEventListener("load",init,!1);